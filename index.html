<!DOCTYPE html>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canlandata</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><a href="/">Canlandata</a></h1>
            <a href="/about">About</a>
        </div>

        <div id="mainContent">

            <div class="content-tabs">
                <button class="active" onclick="showContentSection('chartSection')">Chart</button>
                <button onclick="showContentSection('table1Section')">Table 1</button>
                <button onclick="showContentSection('table2Section')">Table 2</button>
            </div>

            <div id="chartSection">
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="cardSearch" placeholder="Search for a card..." autocomplete="off">
                        <div id="autocompleteList" class="autocomplete-items"></div>
                    </div>
                    <div class="selected-cards" id="selectedCards"></div>
                </div>
                
                <div class="chart-container">
                    <canvas id="playrateChart"></canvas>
                </div>
            </div>
            
            <div id="table1Section" class="hidden">
                <h2>Table 1</h2>
                <p>table 1 coming soon</p>
            </div>

            <div id="table2Section" class="hidden">
                <h2>Table 2</h2>
                <p>table 2 coming soon</p>
            </div>
        </div>
    </div>
 
    <script>
        let data = [];
        let allCards = [];
        let selectedCards = ['Barrowgoyf', 'White Plume Adventurer'];
        let chart = null;

        // Load CSV data
        Papa.parse('data.csv', {
            download: true,
            header: true,
            complete: function(results) {
                data = results.data.filter(row => row.card && row.year_month);
                allCards = [...new Set(data.map(row => row.card))].sort();
                updateChart();
            }
        });

        // Autocomplete functionality
        const searchInput = document.getElementById('cardSearch');
        const autocompleteList = document.getElementById('autocompleteList');

        searchInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            autocompleteList.innerHTML = '';
            
            if (!val) return;
            
            const matches = allCards.filter(card => 
                card.toLowerCase().includes(val) && !selectedCards.includes(card)
            ).slice(0, 50);
            
            matches.forEach(card => {
                const div = document.createElement('div');
                div.textContent = card;
                div.addEventListener('click', () => addCard(card));
                autocompleteList.appendChild(div);
            });
        });

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== searchInput) {
                autocompleteList.innerHTML = '';
            }
        });

        function addCard(card) {
            if (selectedCards.length >= 20) {
                alert('Maximum 20 cards can be selected');
                return;
            }
            if (!selectedCards.includes(card)) {
                selectedCards.push(card);
                updateSelectedCards();
                updateChart();
            }
            searchInput.value = '';
            autocompleteList.innerHTML = '';
        }

        function removeCard(card) {
            selectedCards = selectedCards.filter(c => c !== card);
            updateSelectedCards();
            updateChart();
        }

        function updateSelectedCards() {
            const container = document.getElementById('selectedCards');
            container.innerHTML = selectedCards.map(card => `
                <div class="card-chip">
                    ${card}
                    <button onclick="removeCard('${card.replace(/'/g, "\\'")}')">Ã—</button>
                </div>
            `).join('');
        }

        function updateChart() {
            const ctx = document.getElementById('playrateChart').getContext('2d');
            
            // Get all unique dates and sort them
            const allDates = [...new Set(data.map(row => row.year_month))].sort();
            
            // Prepare datasets
            const datasets = selectedCards.map((card, i) => {
                const cardData = data.filter(row => row.card === card);
                const dataPoints = allDates.map(date => {
                    const row = cardData.find(r => r.year_month === date);
                    return row ? parseFloat(row.playrate) * 100 : null;
                });
                
                const hue = (i * 137.5) % 360;
                const color = `hsl(${hue}, 30%, 50%)`;
                
                return {
                    label: card,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    spanGaps: true
                };
            });

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Play rate by Month'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Play rate'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function showContentSection(sectionId){
            // hide alls sections
            document.getElementById('chartSection').classList.add('hidden');
            document.getElementById('table1Section').classList.add('hidden');
            document.getElementById('table2Section').classList.add('hidden');

            // unhide target section
            document.getElementById(sectionId).classList.remove('hidden');

            // remove active from all buttons
            document.querySelectorAll('.content-tabs button').forEach(btn => {btn.classList.remove('active')});

            // add active to target button
            event.target.classList.add('active')
        }

        
        // Initialize
        updateSelectedCards();
    </script>
</body>
</html>